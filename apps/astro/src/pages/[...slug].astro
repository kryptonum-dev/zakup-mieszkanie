---
import Layout from '@layout/Layout.astro'
import Components, { type ComponentsProps, Components_Query } from '@components/Components.astro'
import metadataFetch from '@utils/metadata.fetch'
import sanityFetch from '@utils/sanity.fetch'

const { slug: _slug } = Astro.params
const slug = `/${_slug || ''}`

const page = await sanityFetch<{ components: ComponentsProps }>({
  query: `*[_type == "page" && slug.current == $slug][0] {
    ${Components_Query}
  }`,
  params: { slug: slug },
})

if (!page) return Astro.rewrite('/404')

const metadata = await metadataFetch(slug)
---

<Layout {...metadata} slug={slug}>
  <Components data={page.components} />
</Layout>
